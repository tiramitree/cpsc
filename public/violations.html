<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Violations</title>
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
    }
    .modal-content {
      background: #fff;
      padding: 16px;
      margin: 50px auto;
      width: 400px;
      position: relative;
    }
    .close-btn {
      position: absolute;
      right: 10px;
      top: 10px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Violations</h1>
  <div id="successMsg" style="color: green; display: none;">Annotation saved successfully</div>

  <table id="violationsTable" border="1">
    <thead>
      <tr>
        <th>Violation_ID</th>
        <th>Listing_ID</th>
        <th>Investigator_Name</th>
        <th>Date_Flagged</th>
        <th>Violation_Status</th>
        <th>Alert_Sent</th>
        <th>Alert_Type</th>
        <th>Alert_Date</th>
        <th>Reasoning</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal -->
  <div class="modal" id="annotateModal">
    <div class="modal-content">
      <span class="close-btn" id="closeModal">&times;</span>
      <h3>Annotate Violation</h3>

      <form id="annotateForm">
        <div>
          <label>
            <input type="radio" name="annotationType" value="True Positive" />
            True Positive
          </label>
          <label>
            <input type="radio" name="annotationType" value="False Positive" />
            False Positive
          </label>
        </div>

        <div>
          <label for="reasoning">Reasoning (required):</label><br />
          <textarea id="reasoning" name="reasoning" rows="3" cols="40"></textarea>
        </div>

        <br />
        <button type="submit" id="submitBtn" disabled>Submit</button>
      </form>
    </div>
  </div>

  <script>
    let currentViolationId = null; 

    async function loadViolations() {
      try {
        const response = await fetch('/api/violations');
        if (!response.ok) {
          throw new Error('Failed to fetch violations, status: ' + response.status);
        }
        const data = await response.json();  
        renderViolations(data);
      } catch (err) {
        console.error('Error loading violations:', err);
      }
    }

    function renderViolations(violations) {
      const tbody = document.querySelector('#violationsTable tbody');
      tbody.innerHTML = '';

      violations.forEach(item => {
        const tr = document.createElement('tr');

        const tdVid = document.createElement('td');
        tdVid.textContent = item.Violation_ID;
        tr.appendChild(tdVid);

        const tdLid = document.createElement('td');
        tdLid.textContent = item.Listing_ID;
        tr.appendChild(tdLid);

        const tdInv = document.createElement('td');
        tdInv.textContent = item.Investigator_Name || '';
        tr.appendChild(tdInv);

        const tdDateFlagged = document.createElement('td');
        tdDateFlagged.textContent = item.Date_Flagged || '';
        tr.appendChild(tdDateFlagged);

        const tdStatus = document.createElement('td');
        tdStatus.textContent = item.Violation_Status || '';
        tr.appendChild(tdStatus);

        const tdAlertSent = document.createElement('td');
        tdAlertSent.textContent = item.Alert_Sent === true ? 'true' : 'false';
        tr.appendChild(tdAlertSent);

        const tdAlertType = document.createElement('td');
        tdAlertType.textContent = item.Alert_Type || '';
        tr.appendChild(tdAlertType);

        const tdAlertDate = document.createElement('td');
        tdAlertDate.textContent = item.Alert_Date || '';
        tr.appendChild(tdAlertDate);

        const tdReasoning = document.createElement('td');
        tdReasoning.textContent = item.Reasoning || '';
        tr.appendChild(tdReasoning);

        const tdAction = document.createElement('td');

        if (item.Violation_Status === 'True Positive' || item.Violation_Status === 'False Positive') {
          tdAction.textContent = 'Annotated';
        } else {
          const btn = document.createElement('button');
          btn.textContent = 'Annotate';
          btn.addEventListener('click', () => openAnnotateModal(item.Violation_ID));
          tdAction.appendChild(btn);
        }
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
      });
    }

    function openAnnotateModal(violationId) {
      currentViolationId = violationId;
      document.getElementById('annotateModal').style.display = 'block';
      document.getElementById('successMsg').style.display = 'none';
      resetForm();
    }

    function closeAnnotateModal() {
      document.getElementById('annotateModal').style.display = 'none';
      resetForm();
    }

    function resetForm() {
      document.getElementById('annotateForm').reset();
      toggleSubmitButton();
    }

    function toggleSubmitButton() {
      const radios = document.querySelectorAll('input[name="annotationType"]');
      const reasoning = document.getElementById('reasoning').value.trim();

      let radioChecked = false;
      radios.forEach(r => {
        if (r.checked) radioChecked = true;
      });

      const submitBtn = document.getElementById('submitBtn');
      if (radioChecked && reasoning.length > 0) {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = true;
      }
    }

    document.querySelectorAll('input[name="annotationType"]').forEach(radio => {
      radio.addEventListener('change', toggleSubmitButton);
    });
    document.getElementById('reasoning').addEventListener('input', toggleSubmitButton);

    document.getElementById('annotateForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const radios = document.querySelectorAll('input[name="annotationType"]');
      let outcomeValue = null;
      radios.forEach(r => { if (r.checked) outcomeValue = r.value; });

      const reasoningValue = document.getElementById('reasoning').value.trim();
      if (!outcomeValue || !reasoningValue) {
        return;
      }

      try {
        const response = await fetch(`/api/violations/${currentViolationId}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            outcome: outcomeValue,
            reasoning: reasoningValue
          })
        });
        if (!response.ok) {
          throw new Error('Patch failed, status: ' + response.status);
        }
        const resData = await response.json();
        console.log('Patch result:', resData);

        document.getElementById('successMsg').style.display = 'block';
        closeAnnotateModal(); 
        loadViolations();     
      } catch (err) {
        console.error('Error patching violation:', err);
        alert('Failed to save annotation. Check console for details.');
      }
    });


    document.getElementById('closeModal').addEventListener('click', closeAnnotateModal);

    window.addEventListener('DOMContentLoaded', loadViolations);
  </script>
</body>
</html>
